package main

import (
	"fmt"
	"log"

	_ "github.com/lib/pq"

	"github.com/gorilla/handlers"
	"github.com/gorilla/mux"
	httpSwagger "github.com/swaggo/http-swagger"
	"net/http"
	"os"

	// API demo https://www.soberkoder.com/swagger-go-api-swaggo/
	// Use https://github.com/swaggo/swag#declarative-comments-format to format REST API
	// pkg/api/docs folder is generated by Swag CLI, check readme.
	"famquest/components/db-manager/pkg/api"
	"famquest/components/db-manager/pkg/api/docs"
	"famquest/components/db-manager/pkg/connection"
	"famquest/components/db-manager/pkg/models"
	"famquest/components/go-common/logger"
)

func init() {
	// Env variables are used to inject the IP to the Host annotation to connect swagger correctly
	// even in prod
	host := os.Getenv("SWAGGER_URL")
	docs.SwaggerInfo.Host = host
	docs.SwaggerInfo.Schemes = []string{os.Getenv("SWAGGER_SCHEMA")}
	docs.SwaggerInfo.BasePath = os.Getenv("SWAGGER_BASE_PATH")
}

// @title FamQuest DB Manager API
// @version 1.0
// @description Handles the connection to the DBs in DB Manager. PostgreSQL and MINIO
// @termsOfService http://swagger.io/terms/
// @contact.name Guillermo Gomez
// @contact.url https://github.com/guigomcha/famquest/
// @contact.email guillermo.gc1994@gmail.com
// @license.name Guillermo Gomez GPL V3
func main() {
	logger.Log.Info("initiating db manager backend")
	initialDbData()
	defer connection.DB.Close()
	r := mux.NewRouter()
	r.PathPrefix("/swagger").Handler(httpSwagger.WrapHandler)
	r.HandleFunc("/health", api.Health).Methods("GET")

	r.HandleFunc("/attachment", api.AttachmentPost).Methods("POST")
	r.HandleFunc("/attachment", api.AttachmentGetAll).Methods("GET")
	r.HandleFunc("/attachment/{id}", api.AttachmentGet).Methods("GET")
	r.HandleFunc("/attachment/{id}", api.AttachmentPut).Methods("PUT")
	r.HandleFunc("/attachment/{id}/ref", api.AttachmentPutRef).Methods("PUT")
	r.HandleFunc("/attachment/{id}", api.AttachmentDelete).Methods("DELETE")

	r.HandleFunc("/spot", api.SpotPost).Methods("POST")
	r.HandleFunc("/spot", api.SpotGetAll).Methods("GET")
	r.HandleFunc("/spot/{id}", api.SpotGet).Methods("GET")
	r.HandleFunc("/spot/{id}", api.SpotPut).Methods("PUT")
	r.HandleFunc("/spot/{id}", api.SpotDelete).Methods("DELETE")

	r.HandleFunc("/location", api.LocationPost).Methods("POST")
	r.HandleFunc("/location", api.LocationGetAll).Methods("GET")
	r.HandleFunc("/location/{id}", api.LocationGet).Methods("GET")
	r.HandleFunc("/location/{id}", api.LocationPut).Methods("PUT")
	r.HandleFunc("/location/{id}/ref", api.LocationPutRef).Methods("PUT")
	r.HandleFunc("/location/{id}", api.LocationDelete).Methods("DELETE")

	r.HandleFunc("/task", api.TaskPost).Methods("POST")
	r.HandleFunc("/task", api.TaskGetAll).Methods("GET")
	r.HandleFunc("/task/{id}", api.TaskGet).Methods("GET")
	r.HandleFunc("/task/{id}/ref", api.TaskPutRef).Methods("PUT")
	r.HandleFunc("/task/{id}", api.TaskPut).Methods("PUT")
	r.HandleFunc("/task/{id}", api.TaskDelete).Methods("DELETE")

	// Start the server
	port := os.Getenv("SWAGGER_PORT")
	if port == "" {
		port = "8080" // Default port if not set
	}
	fmt.Printf("Starting server on port %s...\n", port)
	// Use CORS middleware to allow requests from frontend
	allowedOrigins := handlers.AllowedOrigins([]string{"http://localhost:3000", "http://localhost:8081", "http://localhost:8080"})
	allowedMethods := handlers.AllowedMethods([]string{"GET", "POST", "PUT", "DELETE", "OPTIONS"})
	allowedHeaders := handlers.AllowedHeaders([]string{"Content-Type", "Accept"})
	logger.Log.Debugf("CORS: %+v, %+v, %+v", allowedOrigins, allowedHeaders, allowedMethods)
	// Wrap your router with the CORS middleware

	log.Fatal(http.ListenAndServe(fmt.Sprintf(":%s", port), handlers.CORS(allowedOrigins, allowedMethods, allowedHeaders)(r)))
	// log.Fatal(http.ListenAndServe(fmt.Sprintf(":%s", port), r))
}

func initialDbData() {
	db, err := connection.ConnectToPostgreSQL()
	if err != nil {
		log.Fatalln(err)
	}
	logger.Log.Info("Postgress connected")
	connection.DB = db
	if _, err := db.Exec(models.Schema); err != nil {
		log.Fatalln(err)
	}
	logger.Log.Info("Postgress configured")
	minioClient, err := connection.ConnectToMinio()
	if err != nil {
		log.Fatalln(err)
		return
	}
	logger.Log.Info("Minio configured")
	connection.Minio = minioClient
}
